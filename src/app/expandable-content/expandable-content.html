<!-- Bootstrap Tabs -->
<div class="tabs-container">
    <!-- Tab Headers -->
    <div class="tabs-header d-flex align-items-center justify-content-between border-bottom">
      <ul class="nav nav-tabs mb-0 border-0">
        <li class="nav-item" *ngFor="let tab of getVisibleTabs()">
          <button class="nav-link d-flex align-items-center" 
                  [class.active]="isTabActive(tab.id)"
                  (click)="onTabClick(tab.id)">
            <!-- Tab Icon -->
            <i *ngIf="tab.icon" [class]="tab.icon + ' me-1'"></i>
            <!-- Tab Title -->
            <span>{{ tab.title }}</span>
          </button>
        </li>
      </ul>

      <!-- Single Refresh Icon for Active Tab -->
      <div class="me-3 refresh-container" *ngIf="getSelectedTab()">
        <button class="btn btn-sm btn-outline-secondary d-flex align-items-center"
                (click)="refreshActiveTab($event)"
                [attr.title]="'Refresh: ' + (getSelectedTab()?.title || '')">
          <i class="bi bi-arrow-clockwise" [class.text-success]="getSelectedTab()?.loaded && !getSelectedTab()?.loading"></i>
        </button>
      </div>
    </div>

    <!-- Tab Content -->
    <div class="tab-content p-2">
      <div *ngFor="let tab of getVisibleTabs()" 
           class="tab-pane fade" 
           [class.show]="isTabActive(tab.id)"
           [class.active]="isTabActive(tab.id)">
        
        <!-- Loading State (only show for active tab) -->
        <div *ngIf="isTabActive(tab.id) && tab.loading" class="loading-state">
          <div class="spinner-border text-primary" role="status" aria-hidden="true"></div>
          <p class="mt-2 text-muted">Loading {{ tab.title }}...</p>
        </div>

        <!-- Loaded Content (only for active tab) -->
        <div *ngIf="isTabActive(tab.id) && !tab.loading && tab.loaded" class="h-auto">
          <!-- Table Container with Fixed Height and Scroll -->
          <div class="table-container" [class.empty]="!hasData(tab.id)">
            
            <!-- Empty State -->
            <div *ngIf="!hasData(tab.id)" class="empty-state text-center">
              <i class="bi bi-inbox display-4 text-muted"></i>
              <h5 class="mt-3 text-muted">No Data Available</h5>
              <p class="text-muted">There are no records to display for this tab.</p>
              <button class="btn btn-primary mt-2"
                      (click)="onRefreshClick(tab.id, $event)">
                Try Loading Again
              </button>
            </div>

            <!-- Data Table -->
            <div *ngIf="hasData(tab.id) && !isAnalyticsTab()" class="table-responsive table-wrapper">
              <div class="table-scroll">
                <table class="table table-striped table-hover mb-0">
                <thead class="table-light sticky-top">
                  <tr>
                    <th *ngFor="let column of columns" 
                        [style.width]="column.width"
                        [class.sortable]="column.sortable">
                      {{ column.label }}
                    </th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let item of tab.data; trackBy: trackByFn">
                    <td *ngFor="let column of columns">
                      
                      <!-- Status Badges -->
                      <span *ngIf="column.key === 'status' || column.key === 'priority'" 
                            class="badge" 
                            [class.bg-success]="item[column.key] === 'Completed' || item[column.key] === 'Low'"
                            [class.bg-warning]="item[column.key] === 'In Progress' || item[column.key] === 'Medium'"
                            [class.bg-danger]="item[column.key] === 'On Hold' || item[column.key] === 'High'"
                            [class.bg-primary]="item[column.key] === 'Active' || item[column.key] === 'Pending'"
                            [class.bg-secondary]="item[column.key] === 'Remote' || item[column.key] === 'On Leave'">
                        {{ item[column.key] }}
                      </span>

                      <!-- Progress Bar -->
                      <div *ngIf="column.key === 'progress'" class="d-flex align-items-center">
                        <div class="progress flex-grow-1 me-2 progress-sm">
                          <div class="progress-bar" 
                               [style.width.%]="item[column.key]"
                               [class.bg-success]="item[column.key] > 75"
                               [class.bg-warning]="item[column.key] > 25 && item[column.key] <= 75"
                               [class.bg-danger]="item[column.key] <= 25">
                          </div>
                        </div>
                        <small class="text-nowrap">{{ item[column.key] }}%</small>
                      </div>

                      <!-- Trend Icons -->
                      <span *ngIf="column.key === 'trend'">
                        <i [class]="item[column.key] === 'up' ? 'bi bi-arrow-up-circle text-success' : 'bi bi-arrow-down-circle text-danger'"></i>
                        {{ item[column.key] === 'up' ? 'Increasing' : 'Decreasing' }}
                      </span>

                      <!-- Actions -->
                      <span *ngIf="column.key === 'actions'">
                        <button class="btn btn-sm btn-outline-primary">
                          <i class="bi bi-eye"></i>
                        </button>
                      </span>

                      <!-- Default Display -->
                      <span *ngIf="!['status', 'priority', 'progress', 'trend', 'actions'].includes(column.key)">
                        {{ item[column.key] }}
                      </span>
                    </td>
                  </tr>
                </tbody>
                </table>
              </div>
            </div>

            <!-- Expandable Table for Analytics Tab -->
            <div *ngIf="hasData(tab.id) && isAnalyticsTab()" class="table-responsive flex-grow-1 border rounded">
              <table class="table table-hover mb-0">
                <thead class="table-light position-sticky top-0">
                  <tr>
                    <th class="w-auto" style="width: 50px;"></th>
                    <th class="w-auto">LOB (Line of Business)</th>
                    <th class="w-auto">Total Coverage</th>
                    <th class="w-auto">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <ng-container *ngFor="let item of tab.data; trackBy: trackByFn">
                    <!-- Parent Row -->
                    <tr [class.table-active]="isRowExpanded(item.id)">
                      <td>
                        <button class="btn btn-sm btn-outline-primary d-flex align-items-center justify-content-center"
                                (click)="toggleRow(item.id, $event)"
                                [title]="isRowExpanded(item.id) ? 'Collapse' : 'Expand'"
                                style="width: 30px; height: 30px;">
                          <i class="bi" 
                             [class.bi-chevron-down]="isRowExpanded(item.id)"
                             [class.bi-chevron-right]="!isRowExpanded(item.id)"></i>
                        </button>
                      </td>
                      <td>
                        <strong>{{ item.lob }}</strong>
                      </td>
                      <td>
                        <span class="badge bg-primary">{{ item.totalCoverage || item.coverage.length }}</span>
                      </td>
                      <td>
                        <button class="btn btn-sm btn-outline-secondary">
                          <i class="bi bi-three-dots"></i>
                        </button>
                      </td>
                    </tr>
                    
                    <!-- Child Row (Expanded Content) -->
                    <tr *ngIf="isRowExpanded(item.id)">
                      <td colspan="4" class="p-0 border-0">
                        <div class="bg-light">
                          <div class="p-3 border-bottom border-1">
                            <h6 class="mb-1">Coverage for {{ item.lob }}</h6>
                            <small class="text-muted">{{ item.coverage.length }} coverage items</small>
                          </div>
                          
                          <!-- Child Table -->
                          <div class="p-2">
                            <div class="table-responsive" style="max-height: 200px;">
                              <table class="table table-sm table-bordered mb-0">
                                <thead class="table-secondary position-sticky top-0">
                                  <tr>
                                    <th class="w-auto">ID</th>
                                    <th class="w-auto">Name</th>
                                    <th class="w-auto">Value</th>
                                    <th class="w-auto">Status</th>
                                    <th class="w-auto">Description</th>
                                  </tr>
                                </thead>
                                <tbody>
                                  <tr *ngFor="let coverageItem of item.coverage; trackBy: trackByCoverageFn">
                                    <td>
                                      <span class="badge bg-dark">#{{ coverageItem.id }}</span>
                                    </td>
                                    <td>
                                      <strong>{{ coverageItem.name }}</strong>
                                    </td>
                                    <td>
                                      <span class="text-success fw-bold">{{ coverageItem.value || 'N/A' }}</span>
                                    </td>
                                    <td>
                                      <span class="badge" 
                                            [class.bg-success]="coverageItem.status === 'Active'"
                                            [class.bg-warning]="coverageItem.status === 'Pending'"
                                            [class.bg-danger]="coverageItem.status === 'Inactive'">
                                        {{ coverageItem.status || 'Unknown' }}
                                      </span>
                                    </td>
                                    <td>
                                      <small class="text-muted">{{ coverageItem.description || 'No description' }}</small>
                                    </td>
                                  </tr>
                                </tbody>
                              </table>
                            </div>
                          </div>
                        </div>
                      </td>
                    </tr>
                  </ng-container>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Not Loaded State (only for active tab) -->
        <div *ngIf="isTabActive(tab.id) && !tab.loading && !tab.loaded" class="loading-state text-muted">
          <p>Data not loaded yet</p>
          <button class="btn btn-sm btn-outline-primary"
                  (click)="onRefreshClick(tab.id, $event)">
            Load Data
          </button>
        </div>
      </div>
    </div>
  </div>